<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talentstar - 智能猎头管理系统 Pro+</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #111827;
            --text-sec: #6b7280;
            --border: #e5e7eb;
            --sidebar-width: 240px;
            --status-new: #3b82f6;
            --status-process: #f59e0b;
            --status-success: #10b981;
            --status-fail: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; outline: none; }
        body { background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* 登录页 */
        #login-view { height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%); }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 380px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); text-align: center; }
        .login-logo { font-size: 24px; font-weight: 800; color: var(--primary); margin-bottom: 30px; }
        .form-input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 6px; transition: 0.2s; }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; background: var(--primary); color: white; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover { background: var(--primary-dark); }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background: #f9fafb; }
        .btn-edit { background: #f59e0b; color: white; }
        .btn-edit:hover { background: #d97706; }
        .btn-danger { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; }
        .btn-danger:hover { background: #fecaca; }

        /* 主系统布局 */
        #app-view { display: none; height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        .brand { padding: 20px; font-size: 20px; font-weight: 800; color: var(--primary); border-bottom: 1px solid var(--border); }
        .nav-menu { flex: 1; padding: 20px 10px; }
        .nav-item { display: flex; align-items: center; padding: 12px 15px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; color: var(--text-sec); text-decoration: none; }
        .nav-item:hover, .nav-item.active { background: #eff6ff; color: var(--primary); font-weight: 500; }
        .nav-item i { margin-right: 10px; width: 20px; text-align: center; }
        .user-panel { padding: 20px; border-top: 1px solid var(--border); font-size: 14px; }
        .logout-btn { color: #dc2626; cursor: pointer; float: right; }

        .main-content { flex: 1; overflow-y: auto; padding: 30px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .page-title { font-size: 24px; font-weight: bold; }
        
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        .toolbar { display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        .search-bar { flex: 1; max-width: 300px; margin-bottom: 0 !important; }
        
        /* 仪表盘样式 */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .stat-label { font-size: 14px; color: var(--text-sec); }
        .stat-value { font-size: 28px; font-weight: bold; margin-top: 5px; color: var(--text-main); }

        /* 表格优化 */
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { text-align: left; padding: 12px 15px; background: #f9fafb; color: var(--text-sec); font-size: 13px; font-weight: 600; border-bottom: 2px solid var(--border); }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); font-size: 14px; white-space: nowrap; }
        tr:hover { background: #f9fafb; cursor: pointer; }
        
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 12px; background: #e0e7ff; color: #3730a3; display: inline-block; margin: 2px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .highlight-text { color: var(--primary); font-weight: 600; }

        /* 弹窗 */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; width: 700px; max-width: 95%; border-radius: 12px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); text-align: right; background: #f9fafb; display: flex; justify-content: flex-end; gap: 10px; }
        .close-modal { background: none; border: none; font-size: 20px; cursor: pointer; color: #999; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-sec); font-weight: 500; }
        .file-drop-area { border: 2px dashed var(--border); border-radius: 6px; padding: 15px; text-align: center; cursor: pointer; position: relative; background: #f9fafb; }
        .loading-text { color: var(--primary); font-size: 13px; display: none; }

        /* 批量导入进度 */
        #batch-progress { margin-top: 15px; display: none; background: #f3f4f6; border-radius: 6px; overflow: hidden; height: 10px; }
        #batch-progress-bar { background: var(--primary); height: 100%; width: 0%; transition: 0.3s; }

        .detail-row { display: flex; margin-bottom: 12px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .detail-label { width: 100px; color: var(--text-sec); font-weight: 500; flex-shrink: 0; }
        .detail-val { flex: 1; }

        /* 简历预览区域 */
        #resume-preview-box { margin-top: 15px; border: 1px solid var(--border); height: 400px; display: none; overflow: auto; background: #525659; border-radius: 6px; }
        canvas { display: block; margin: 10px auto; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <div id="login-view">
        <div class="login-box">
            <div class="login-logo"><i class="fas fa-star"></i> Talentstar</div>
            <form id="login-form">
                <input type="text" id="username" class="form-input" placeholder="用户名" value="admin">
                <input type="password" id="password" class="form-input" placeholder="密码" value="Mkdmkd19980610..">
                <button type="submit" class="btn" style="width: 100%;">安全登录</button>
            </form>
        </div>
    </div>

    <div id="app-view">
        <nav class="sidebar">
            <div class="brand"><i class="fas fa-star"></i> Talentstar</div>
            <div class="nav-menu">
                <a class="nav-item" onclick="switchModule('dashboard')" id="nav-dashboard"><i class="fas fa-chart-pie"></i> 业务看板</a>
                <a class="nav-item active" onclick="switchModule('candidates')" id="nav-candidates"><i class="fas fa-user-tie"></i> 候选人管理</a>
                <a class="nav-item" onclick="switchModule('companies')" id="nav-companies"><i class="fas fa-building"></i> 公司管理</a>
                <a class="nav-item" onclick="switchModule('jobs')" id="nav-jobs"><i class="fas fa-briefcase"></i> 职位管理</a>
            </div>
            <div class="user-panel">
                <div onclick="exportDatabase()" style="cursor:pointer; margin-bottom:10px; color:var(--primary); font-size:12px;"><i class="fas fa-download"></i> 备份数据库 (JSON)</div>
                <span><i class="fas fa-user-circle"></i> admin</span>
                <span class="logout-btn" onclick="logout()">退出</span>
            </div>
        </nav>
        <main class="main-content" id="module-container"></main>
    </div>

    <div id="modal-container" class="modal-overlay"></div>

    <script>
     const CONFIG = {
            login: { u: 'admin', p: 'Mkdmkd19980610..' },
            storageKeys: { candidates: 'ts_candidates', companies: 'ts_companies', jobs: 'ts_jobs', auth: 'ts_auth' },
            industryData: {
                "半导体/芯片": { 
                    "IC设计": ["模拟IC/射频", "数字设计", "验证/DFT", "版图Layout", "系统架构"], 
                    "工艺制造": ["PIE工艺整合", "光刻/蚀刻/薄膜", "良率YE/失效分析FA", "设备维修"], 
                    "封装测试": ["封装研发", "ATE测试", "FAE应用工程师", "芯片销售/市场"]
                },
                "财务/金融": {
                    "财务管理": ["CFO/财务总监", "财务BP", "税务筹划", "审计/合规", "成本会计"],
                    "量化交易": ["C++低延迟", "策略研发", "量化交易员", "机器学习算法"],
                    "传统金融": ["风控", "行业研究", "投资经理/VP", "IR投资者关系"]
                },
                "汽车/新能源": { 
                    "智能驾驶": ["感知算法", "规划控制", "高精地图", "激光雷达"], 
                    "三电系统": ["BMS", "电机控制", "电池研发", "热管理"],
                    "整车研发": ["底盘", "内外饰", "电子电器架构", "NVH测试"]
                },
                "工业制造": { 
                    "核心研发": ["机械设计", "电气工程师", "PLC/嵌入式", "材料研发"], 
                    "生产运营": ["厂长/总工", "精益生产/IE", "供应链/采购", "质量管理QA/QC"]
                },
                "互联网/软件": { 
                    "后端开发": ["Java", "Go", "Python", "架构师"], 
                    "前端开发": ["React", "Vue", "Node.js"], 
                    "人工智能": ["NLP", "CV", "大模型"] 
                },
                "医疗/生物": { 
                    "生物制药": ["大分子", "临床开发", "药物化学", "医学总监"], 
                    "医疗器械": ["结构设计", "注册法规", "影像算法"]
                }
            },
            candidateStatus: ["简历初筛", "面试推进", "待入职", "已入职", "人才入库", "不匹配"]
        };

        let db = { candidates: [], companies: [], jobs: [] };
        
        window.onload = () => {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
            loadData();
            if (localStorage.supabase.insert(CONFIG.storageKeys.auth) === 'true') showApp();
        };

        function loadData() {
            db.candidates = JSON.parse(localStorage.supabase.insert(CONFIG.storageKeys.candidates) || '[]');
            db.companies = JSON.parse(localStorage.supabase.insert(CONFIG.storageKeys.companies) || '[]');
            db.jobs = JSON.parse(localStorage.supabase.insert(CONFIG.storageKeys.jobs) || '[]');
        }

        function saveData() {
            try {
                localStorage.supabase.insert(CONFIG.storageKeys.candidates, JSON.stringify(db.candidates));
                localStorage.supabase.insert(CONFIG.storageKeys.companies, JSON.stringify(db.companies));
                localStorage.supabase.insert(CONFIG.storageKeys.jobs, JSON.stringify(db.jobs));
                return true;
            } catch (e) { alert('存储空间不足，请清理简历附件'); return false; }
        }

        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            if (document.getElementById('username').value === CONFIG.login.u && document.getElementById('password').value === CONFIG.login.p) {
                localStorage.supabase.insert(CONFIG.storageKeys.auth, 'true');
                showApp();
            } else alert('验证失败');
        };

        function logout() { localStorage.supabase.insertItem(CONFIG.storageKeys.auth); location.reload(); }
        function showApp() { document.getElementById('login-view').style.display = 'none'; document.getElementById('app-view').style.display = 'flex'; switchModule('dashboard'); }

        function switchModule(mod) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.supabase.insert('active'));
            document.getElementById('nav-' + mod).classList.add('active');
            const container = document.getElementById('module-container');
            
            if (mod === 'dashboard') renderDashboard(container);
            if (mod === 'candidates') renderCandidates(container);
            if (mod === 'companies') renderCompanies(container);
            if (mod === 'jobs') renderJobs(container);
        }

        // ======================= 业务看板 (保留您的原有逻辑) =======================
        function renderDashboard(container) {
            const counts = {
                total: db.candidates.length,
                interview: db.candidates.filter(c => c.status === '面试推进').length,
                success: db.candidates.filter(c => c.status === '已入职').length,
                company: db.companies.length
            };

            container.innerHTML = `
                <div class="page-header"><div class="page-title">业务概览</div></div>
                <div class="stat-grid">
                    <div class="stat-card"><div class="stat-label">人才库总量</div><div class="stat-value">${counts.total}</div></div>
                    <div class="stat-card" style="border-left-color: #f59e0b"><div class="stat-label">面试推进中</div><div class="stat-value">${counts.interview}</div></div>
                    <div class="stat-card" style="border-left-color: #10b981"><div class="stat-label">本月已入职</div><div class="stat-value">${counts.success}</div></div>
                    <div class="stat-card" style="border-left-color: #3b82f6"><div class="stat-label">合作客户</div><div class="stat-value">${counts.company}</div></div>
                </div>
                <div class="card">
                    <h3>最近录入候选人</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>姓名</th><th>状态</th><th>工龄</th><th>录入时间</th></tr></thead>
                            <tbody>${db.candidates.slice(0,5).map(c => `<tr><td class="highlight-text">${c.name}</td><td>${c.status}</td><td>${c.expYear}年</td><td>${new Date(c.id).toLocaleDateString()}</td></tr>`).join('')}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // ======================= 渲染列表 (增强多词筛选 + 批量按钮) =======================
        function renderCandidates(container) {
            container.innerHTML = `
                <div class="page-header">
                    <div class="page-title">候选人管理</div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-outline" onclick="openBatchImport()"><i class="fas fa-file-import"></i> 批量导入</button>
                        <button class="btn" onclick="openCandidateForm()">+ 新增候选人</button>
                    </div>
                </div>
                <div class="card">
                    <div class="toolbar">
                        <input type="text" class="form-input search-bar" id="search-c" placeholder="支持多关键词(用空格隔开)..." oninput="filterC()">
                        <select class="form-input" id="filter-status" style="width:130px;" onchange="filterC()">
                            <option value="">所有状态</option>
                            ${CONFIG.candidateStatus.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                        <select class="form-input" id="filter-exp" style="width:130px;" onchange="filterC()">
                            <option value="">所有工龄</option>
                            <option value="0-3">3年以下</option>
                            <option value="3-5">3-5年</option>
                            <option value="5-10">5-10年</option>
                            <option value="10-50">10年以上</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr><th>姓名</th><th>当前状态</th><th>当前公司</th><th>当前职位</th><th>年限</th><th>技术方向</th><th>简历</th></tr>
                            </thead>
                            <tbody id="list-c"></tbody>
                        </table>
                    </div>
                </div>`;
            filterC();
        }

        // 核心更新：多关键词检索逻辑
        function filterC() {
            const val = document.getElementById('search-c')?.value.trim().toLowerCase() || '';
            const keywords = val.split(/\s+/).filter(k => k.length > 0); // 按空格切割关键词
            
            const statusF = document.getElementById('filter-status')?.value || '';
            const expF = document.getElementById('filter-exp')?.value || '';

            const tbody = document.getElementById('list-c'); tbody.innerHTML = '';
            
            db.candidates.filter(c => {
                // 待匹配的大字符串
                const searchString = `${c.name} ${c.currentCompany} ${c.skills} ${c.tech} ${c.remarks}`.toLowerCase();
                
                // 多关键词 AND 匹配：输入的每一个词都必须在 searchString 中找到
                const matchSearch = keywords.length === 0 || keywords.every(kw => searchString.includes(kw));
                
                const matchStatus = statusF === '' || c.status === statusF;
                
                let matchExp = true;
                if(expF) {
                    const [min, max] = expF.split('-').map(Number);
                    const year = Number(c.expYear) || 0;
                    matchExp = year >= min && year <= max;
                }
                
                return matchSearch && matchStatus && matchExp;
            }).forEach(c => {
                const tr = document.createElement('tr');
                tr.onclick = () => showCandidateDetail(c.id);
                const statusColor = c.status === '已入职' ? 'var(--status-success)' : (c.status === '不匹配' ? 'var(--status-fail)' : 'var(--status-new)');
                tr.innerHTML = `
                    <td class="highlight-text">${c.name}</td>
                    <td><span class="status-dot" style="background:${statusColor}"></span>${c.status || '人才入库'}</td>
                    <td>${c.currentCompany || '-'}</td>
                    <td>${c.currentJob || '-'}</td>
                    <td>${c.expYear ? c.expYear + '年' : '-'}</td>
                    <td><span class="tag">${c.tech || '-'}</span></td>
                    <td>${c.resumeData ? '<i class="fas fa-file-pdf" style="color:#ef4444"></i>' : '-'}</td>`;
                tbody.appendChild(tr);
            });
        }

        // ======================= 核心功能：批量导入 =======================
        function openBatchImport() {
            const body = `
                <div class="file-drop-area" id="batch-drop-zone">
                    <i class="fas fa-cloud-upload-alt" style="font-size:30px; color:var(--primary)"></i>
                    <p style="margin-top:10px">点击选择或拖放多个简历文件 (PDF/Word)</p>
                    <input type="file" multiple style="position:absolute;inset:0;opacity:0;cursor:pointer" onchange="handleBatchFile(this)">
                </div>
                <div id="batch-status" style="margin-top:15px; font-size:13px; color:var(--text-sec)">等待上传...</div>
                <div id="batch-progress"><div id="batch-progress-bar"></div></div>
            `;
            showModal('批量快速入库', body, () => closeModal(), '关闭', 'btn-outline');
        }

        async function handleBatchFile(input) {
            const files = Array.from(input.files);
            if(files.length === 0) return;
            
            const statusEl = document.getElementById('batch-status');
            const progress = document.getElementById('batch-progress');
            const progressBar = document.getElementById('batch-progress-bar');
            
            progress.style.display = 'block';
            let success = 0;

            for(let i=0; i<files.length; i++) {
                const file = files[i];
                statusEl.innerText = `正在处理(${i+1}/${files.length}): ${file.name}`;
                progressBar.style.width = ((i+1)/files.length * 100) + '%';

                try {
                    const parsed = await parseFileLogic(file);
                    const newCandidate = {
                        id: Date.now() + i,
                        name: parsed.name,
                        status: '人才入库',
                        expYear: parsed.expYear || '',
                        phone: parsed.phone || '',
                        city: '', tech: '', currentCompany: '', currentJob: '',
                        targetCompId: 0, targetJobId: 0,
                        skills: '', remarks: '批量导入于 ' + new Date().toLocaleDateString(),
                        resumeData: parsed.base64,
                        resumeName: file.name
                    };
                    db.candidates.unshift(newCandidate);
                    success++;
                } catch(e) { console.error(e); }
            }
            
            saveData();
            statusEl.innerHTML = `<b style="color:var(--status-success)">处理完成！成功导入 ${success} 份简历。</b>`;
            if(success > 0) switchModule('candidates');
        }

        // 抽离的统一解析逻辑
        async function parseFileLogic(file) {
            let text = '';
            let base64 = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });

            if(file.type==='application/pdf') {
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                const page = await pdf.getPage(1);
                text = (await page.getTextContent()).items.map(i => i.str).join(' ');
            } else {
                text = (await mammoth.extractRawText({arrayBuffer: await file.arrayBuffer()})).value;
            }

            const expMatch = text.match(/(\d+)\s*年[工作]*经验/);
            const phoneMatch = text.match(/1[3-9]\d{9}/);
            let name = file.name.split(/[._-]/)[0];
            if(name.length > 4) name = name.substring(0,4);

            return {
                name: name,
                expYear: expMatch ? expMatch[1] : '',
                phone: phoneMatch ? phoneMatch[0] : '',
                base64: base64
            };
        }

        // ======================= 详情及预览 (保持原样) =======================
        async function showCandidateDetail(id) {
            const c = db.candidates.find(x => x.id === id);
            const body = `
                <div class="detail-row"><div class="detail-label">姓名</div><div class="detail-val">${c.name} [${c.status || '人才入库'}]</div></div>
                <div class="detail-row"><div class="detail-label">基本信息</div><div class="detail-val">${c.expYear ? c.expYear+'年经验' : ''} | ${c.city || '城市未知'}</div></div>
                <div class="detail-row"><div class="detail-label">联系方式</div><div class="detail-val">${c.phone || '-'} / ${c.email || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">当前公司</div><div class="detail-val"><b>${c.currentCompany || '-'}</b> · ${c.currentJob || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">推荐目标</div><div class="detail-val">${getCompName(c.targetCompId)} - ${getJobName(c.targetJobId)}</div></div>
                <div class="detail-row"><div class="detail-label">技能标签</div><div class="detail-val">${c.skills || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">备注</div><div class="detail-val">${c.remarks || '-'}</div></div>
                ${c.resumeData ? `
                    <div style="display:flex;gap:10px;margin-top:10px">
                        <button class="btn btn-outline" style="flex:1" onclick="previewResume('${c.resumeData}')"><i class="fas fa-eye"></i> 在线预览简历</button>
                        <a href="${c.resumeData}" download="${c.resumeName}" class="btn btn-outline" style="flex:1"><i class="fas fa-download"></i> 下载简历</a>
                    </div>
                    <div id="resume-preview-box"></div>
                ` : ''}`;
            showModal(c.name + ' 完整档案', body, () => openCandidateForm(c), '编辑资料', 'btn-edit', () => {
                if(confirm('确定删除该候选人吗？')) {
                    db.candidates = db.candidates.filter(x => x.id !== id);
                    saveData(); closeModal(); switchModule('candidates');
                }
            });
        }

        async function previewResume(base64) {
            const box = document.getElementById('resume-preview-box');
            box.style.display = 'block';
            box.innerHTML = '<div style="color:white;padding:20px;text-align:center">正在加载预览...</div>';
            try {
                const pdfData = atob(base64.split(',')[1]);
                const loadingTask = pdfjsLib.getDocument({data: pdfData});
                const pdf = await loadingTask.promise;
                box.innerHTML = '';
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({scale: 1.2});
                    const canvas = document.createElement('canvas');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({canvasContext: canvas.getContext('2d'), viewport}).promise;
                    box.appendChild(canvas);
                }
            } catch (e) { box.innerHTML = '<div style="color:white;padding:20px">在线预览仅支持标准PDF文件。</div>'; }
        }

        // ======================= 表单逻辑 =======================
        function openCandidateForm(editObj = null) {
            const compOpts = `<option value="">-- 请选择 --</option>` + db.companies.map(c => `<option value="${c.id}" ${editObj?.targetCompId==c.id?'selected':''}>${c.name}</option>`).join('');
            const statusOpts = CONFIG.candidateStatus.map(s => `<option value="${s}" ${editObj?.status==s?'selected':''}>${s}</option>`).join('');
            
            const body = `<div class="form-grid">
                ${!editObj ? `<div class="full-width file-drop-area" id="drop-zone"><i class="fas fa-upload"></i> 上传简历解析并存库 (PDF/Word)<input type="file" style="position:absolute;inset:0;opacity:0;cursor:pointer" onchange="handleParse(this)"><div id="parse-ld" class="loading-text">解析中...</div></div>` : ''}
                <div class="form-group"><label>姓名*</label><input id="f-name" class="form-input" value="${editObj?.name || ''}"></div>
                <div class="form-group"><label>流程状态</label><select id="f-status" class="form-input">${statusOpts}</select></div>
                <div class="form-group"><label>工作年限(年)</label><input id="f-exp" type="number" class="form-input" value="${editObj?.expYear || ''}"></div>
                <div class="form-group"><label>手机</label><input id="f-phone" class="form-input" value="${editObj?.phone || ''}"></div>
                <div class="form-group"><label>城市</label><input id="f-city" class="form-input" value="${editObj?.city || ''}"></div>
                <div class="form-group"><label>技术方向</label><select id="f-tech" class="form-input"></select></div>
                <div class="form-group"><label>当前公司</label><input id="f-curr-c" class="form-input" value="${editObj?.currentCompany || ''}"></div>
                <div class="form-group"><label>当前职位</label><input id="f-curr-j" class="form-input" value="${editObj?.currentJob || ''}"></div>
                <div class="form-group"><label>推荐至公司</label><select id="f-t-comp" class="form-input" onchange="casComp()">${compOpts}</select></div>
                <div class="form-group"><label>推荐职位</label><select id="f-t-job" class="form-input"></select></div>
                <input type="hidden" id="f-ind" value="${editObj?.industry || '互联网/软件'}">
                <input type="hidden" id="f-role" value="${editObj?.role || '后端开发'}">
                <div class="form-group full-width"><label>技能标签</label><input id="f-skills" class="form-input" value="${editObj?.skills || ''}"></div>
                <div class="form-group full-width"><label>备注</label><textarea id="f-rem" class="form-input">${editObj?.remarks || ''}</textarea></div>
            </div>`;
            
            showModal(editObj ? '编辑候选人' : '新增候选人', body, () => {
                const name = document.getElementById('f-name').value; if(!name) return alert('姓名必填');
                const data = {
                    id: editObj ? editObj.id : Date.now(),
                    name, status: document.getElementById('f-status').value,
                    expYear: document.getElementById('f-exp').value, phone: document.getElementById('f-phone').value,
                    city: document.getElementById('f-city').value, industry: document.getElementById('f-ind').value,
                    role: document.getElementById('f-role').value, tech: document.getElementById('f-tech').value,
                    currentCompany: document.getElementById('f-curr-c').value, currentJob: document.getElementById('f-curr-j').value,
                    targetCompId: Number(document.getElementById('f-t-comp').value), targetJobId: Number(document.getElementById('f-t-job').value),
                    skills: document.getElementById('f-skills').value, remarks: document.getElementById('f-rem').value,
                    resumeData: editObj?.resumeData || window._tempResumeData || null, resumeName: editObj?.resumeName || window._tempResumeName || null
                };
                if(editObj) db.candidates = db.candidates.map(x => x.id === editObj.id ? data : x);
                else db.candidates.unshift(data);
                if(saveData()) { window._tempResumeData = null; closeModal(); switchModule('candidates'); }
            });

            const ts = document.getElementById('f-tech');
            const flatTech = [];
            Object.values(CONFIG.industryData).forEach(ind => Object.values(ind).forEach(list => flatTech.push(...list)));
            [...new Set(flatTech)].forEach(t => ts.add(new Option(t, t)));
            if(editObj) { ts.value = editObj.tech; casComp(); document.getElementById('f-t-job').value = editObj.targetJobId; }
        }

        // ======================= 数据导出/辅助功能 =======================
        function exportDatabase() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "Talentstar_Backup_" + new Date().toLocaleDateString() + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.supabase.insert();
        }
// 这是为你新增的导入功能
function importDatabase() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = event => {
            try {
                const importedDb = JSON.parse(event.target.result);
                // 简单的格式校验
                if (importedDb.candidates && importedDb.companies) {
                    if (confirm('导入将覆盖当前浏览器存储的所有数据，确定吗？')) {
                        db = importedDb;
                        saveData();
                        alert('数据同步成功！页面即将刷新');
                        location.reload();
                    }
                } else {
                    alert('文件格式不正确，请确保上传的是从本系统导出的 JSON 备份。');
                }
            } catch (err) {
                alert('解析文件失败，请检查文件是否损坏。');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}
        function renderCompanies(container) {
            container.innerHTML = `<div class="page-header"><div class="page-title">公司管理</div><button class="btn" onclick="openCompanyForm()">+ 新增公司</button></div>
                <div class="card"><table><thead><tr><th>公司名称</th><th>状态</th><th>备注</th></tr></thead><tbody id="list-comp"></tbody></table></div>`;
            db.companies.forEach(c => {
                const tr = document.createElement('tr'); tr.onclick = () => showCompanyDetail(c.id);
                tr.innerHTML = `<td><b>${c.name}</b></td><td><span class="tag">${c.status}</span></td><td>${c.remarks || '-'}</td>`;
                document.getElementById('list-comp').appendChild(tr);
            });
        }

        function openCompanyForm(editObj = null) {
            const body = `<div class="form-group"><label>公司名称</label><input id="fc-name" class="form-input" value="${editObj?.name || ''}"></div>
                <div class="form-group"><label>状态</label><select id="fc-status" class="form-input"><option>待BD</option><option>已合作</option><option>潜在客户</option></select></div>
                <div class="form-group"><label>备注</label><textarea id="fc-rem" class="form-input">${editObj?.remarks || ''}</textarea></div>`;
            showModal(editObj ? '编辑公司' : '新增公司', body, () => {
                const name = document.getElementById('fc-name').value; if(!name) return;
                const data = { id: editObj?editObj.id:Date.now(), name, status: document.getElementById('fc-status').value, remarks: document.getElementById('fc-rem').value };
                if(editObj) db.companies = db.companies.map(x => x.id === editObj.id ? data : x);
                else db.companies.unshift(data);
                saveData(); closeModal(); switchModule('companies');
            });
            if(editObj) document.getElementById('fc-status').value = editObj.status;
        }

        function renderJobs(container) {
            container.innerHTML = `<div class="page-header"><div class="page-title">职位管理</div><button class="btn" onclick="openJobForm()">+ 新增职位</button></div>
                <div class="card"><table><thead><tr><th>职位</th><th>所属公司</th><th>备注</th></tr></thead><tbody id="list-job"></tbody></table></div>`;
            db.jobs.forEach(j => {
                const tr = document.createElement('tr'); tr.onclick = () => showJobDetail(j.id);
                tr.innerHTML = `<td><b>${j.title}</b></td><td>${getCompName(j.compId)}</td><td>${j.remarks || '-'}</td>`;
                document.getElementById('list-job').appendChild(tr);
            });
        }

        function openJobForm(editObj = null) {
            const compOpts = db.companies.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const body = `<div class="form-group"><label>所属公司</label><select id="fj-comp" class="form-input">${compOpts}</select></div>
                <div class="form-group"><label>职位名称</label><input id="fj-title" class="form-input" value="${editObj?.title || ''}"></div>
                <div class="form-group"><label>备注</label><textarea id="fj-rem" class="form-input">${editObj?.remarks || ''}</textarea></div>`;
            showModal(editObj ? '编辑职位' : '新增职位', body, () => {
                const title = document.getElementById('fj-title').value; if(!title) return;
                const data = { id: editObj?editObj.id:Date.now(), title, compId: Number(document.getElementById('fj-comp').value), remarks: document.getElementById('fj-rem').value };
                if(editObj) db.jobs = db.jobs.map(x => x.id === editObj.id ? data : x);
                else db.jobs.unshift(data);
                saveData(); closeModal(); switchModule('jobs');
            });
            if(editObj) document.getElementById('fj-comp').value = editObj.compId;
        }

        function casComp() {
            const cid = document.getElementById('f-t-comp').value; const js = document.getElementById('f-t-job');
            js.innerHTML = '<option value="0">人才库</option>';
            db.jobs.filter(j => j.compId == cid).forEach(j => js.add(new Option(j.title, j.id)));
        }

        async function handleParse(input) {
            const file = input.files[0]; if(!file) return;
            const ld = document.getElementById('parse-ld'); ld.style.display = 'block';
            try {
                const res = await parseFileLogic(file);
                if(res.expYear) document.getElementById('f-exp').value = res.expYear;
                if(res.phone) document.getElementById('f-phone').value = res.phone;
                if(res.name) document.getElementById('f-name').value = res.name;
                window._tempResumeData = res.base64;
                window._tempResumeName = file.name;
            } catch(e) { console.error(e); } finally { ld.style.display = 'none'; }
        }

        function showModal(title, body, confirmCb, confirmText = '保存', btnClass = 'btn', deleteCb = null) {
            const container = document.getElementById('modal-container');
            let footerHtml = `<button class="btn btn-outline" onclick="closeModal()">取消</button>`;
            if(deleteCb) footerHtml = `<button class="btn btn-danger" id="modal-del" style="margin-right:auto">删除</button>` + footerHtml;
            footerHtml += `<button class="${btnClass}" id="modal-ok">${confirmText}</button>`;
            container.innerHTML = `<div class="modal"><div class="modal-header">${title}<button class="close-modal" onclick="closeModal()">×</button></div>
                <div class="modal-body">${body}</div><div class="modal-footer">${footerHtml}</div></div>`;
            container.style.display = 'flex';
            document.getElementById('modal-ok').onclick = confirmCb;
            if(deleteCb) document.getElementById('modal-del').onclick = deleteCb;
        }
        function closeModal() { document.getElementById('modal-container').style.display = 'none'; }
        function getCompName(id) { return db.companies.find(x => x.id === id)?.name || '-'; }
        function getJobName(id) { return db.jobs.find(x => x.id === id)?.title || '-'; }
        function showCompanyDetail(id) {
            const c = db.companies.find(x => x.id === id);
            const body = `<div class="detail-row"><div class="detail-label">公司名称</div><div class="detail-val">${c.name}</div></div>
                <div class="detail-row"><div class="detail-label">状态</div><div class="detail-val">${c.status}</div></div>
                <div class="detail-row"><div class="detail-label">备注</div><div class="detail-val">${c.remarks || '-'}</div></div>`;
            showModal('公司详情', body, () => openCompanyForm(c), '编辑公司', 'btn-edit', () => {
                db.companies = db.companies.filter(x => x.id !== id);
                saveData(); closeModal(); switchModule('companies');
            });
        }
        function showJobDetail(id) {
            const j = db.jobs.find(x => x.id === id);
            const body = `<div class="detail-row"><div class="detail-label">职位名称</div><div class="detail-val">${j.title}</div></div>
                <div class="detail-row"><div class="detail-label">所属公司</div><div class="detail-val">${getCompName(j.compId)}</div></div>
                <div class="detail-row"><div class="detail-label">备注</div><div class="detail-val">${j.remarks || '-'}</div></div>`;
            showModal('职位详情', body, () => openJobForm(j), '编辑职位', 'btn-edit', () => {
                db.jobs = db.jobs.filter(x => x.id !== id);
                saveData(); closeModal(); switchModule('jobs');
            });
        }
    </script>
</body>

</html>
